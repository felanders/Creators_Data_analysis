---
title: "Creators Statistical Analysis"
output:
  pdf_document: default
  html_document:
    df_print: paged
  html_notebook: default
  author: Andreas Felderer
---

# Libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse) # Data wrangling
library(ggplot2) # Plots
library(viridis) # beautiful color scale
library(estimatr) # regressions with robust Se
library(modelsummary) # For lm_robust tables
library(rstatix) # Wilcoxon tests
library(kableExtra) # Fancy output 
```

# Read Data
```{r read_data}
# Main Study
read.csv("creators_data.csv",
         sep = ";",
         stringsAsFactors = T) %>% 
  rename(Payoff.Fee = Payoff...Fee) %>% 
  mutate(rival_main = ifelse(Treatment == "rival" & w_p_r == 2, 1,0),
         rival_supp = ifelse(Treatment == "rival" & w_p_r == 1, 1,0),
         nonrival = ifelse(Treatment =="nonrival", 1,0),
         participant = row_number()) %>% 
  mutate(Treat = ifelse(rival_main == 1, "Rival Main", 
                        ifelse(rival_supp == 1, "Rival Supp.", "Nonrival"))
         ) -> df

# Calibration Study
read.csv("creators_data_perception.csv", 
         sep = ";", 
         stringsAsFactors = T, 
         fileEncoding = "latin1") %>% 
  # Remove empty lines
  filter(is.na(participant) != T) -> df_cal
```


# Statistics

## Main and Supplementary Study
Values in the Paper:

# :TODO: 1 In the paper the number of participants is reported as 210 in main study and 90 in supplementary study (page 6)
  - Session duration: 105 min -> Not available in the data
  - Average earnings: 60 USD 
  
```{r earnings}
df %>% 
  summarise(Mean_Earnings = round(mean(Payoff.Fee), 0))
```

# :TODO: 2 The following statement it can be interpreted in two ways (page 6)
"users earn on average more than 10 % of their monthly budget net of rent"
    1. The mean of (earning in percent of the monthly budget)
    2. The (mean of the earning) in percent of (the mean of the monthly budget)
```{r}
df %>% 
  filter(monthly_budget != 0) %>% 
  mutate(earnings_perc = Payoff.Fee/monthly_budget*100) %>% 
  summarise(Mean_earnings_percentage = round(mean(earnings_perc), 1))

mean(df$Payoff.Fee)/mean(df$monthly_budget)*100
```

  - Fraction female:
    - non-rival: 0.60 (SD = 0.49)
    - rival_main: 0.47 (SD = 0.50)
    - rival_supp: 0.58 (SD = 0.50)
  - Mean age:
    - non-rival: 22 (SD = 2.7)
    - rival_main: 22 (SD = 2.3)
    - rival_supp: 22 (SD = 2.7)
  - Median monthly budget: 
    - non-rival: 400 (SD = 380)
    - rival_main: 480 (SD = 302)
    - rival_supp: 400 (SD = 487)

```{r overview_statistics}
df %>%
  group_by(Treat) %>% 
  summarise(Female_Fraction = round(1-mean(sex_d),2),
            Gender_SD = round(sd(sex_d),2),
            Age_mean = round(mean(age),0),
            Age_SD = round(sd(age),1),
            Monthly_budget_median = median(monthly_budget),
            Monthly_budget_sd = round(sd(monthly_budget),0))
```
## Wilcoxon Tests: 

  - rival-main vs. non-rival
    - Gender (W = 1170, p = 0.18)
    - Age (W = 1388, p = 0.81)
    - Income (W = 1292, p = 0.71)

  - rival-supp vs. non-rival
    - Gender (W = 1320, p = 0.82)
    - Age (W = 1227, p = 0.42)
    - Income (W = 1261, p = 0.56)

```{r Wilcox_gender}
wilcox_test(sex_d~Treat, data = df,  
            comparisons = list(c("Nonrival", "Rival Main"),
                               c("Nonrival", "Rival Supp.")))
```

```{r Wilcox_age}
wilcox_test(age~Treat, data = df,  
              comparisons = list(c("Nonrival", "Rival Main"),
                                 c("Nonrival", "Rival Supp.")))
```

```{r Wilcox_income}
wilcox_test(monthly_budget~Treat, data = df,
            comparisons = list(c("Nonrival", "Rival Main"),
                               c("Nonrival", "Rival Supp.")))
```

## Calibration Study

  - Mean earning: 34.70 USD
  
# :TODO: 3 There is a small inconsitency with the value reported in the paper (page 10 Footnote 10)

```{r payoff_cal}
df_cal %>% 
  summarise(Mean_Earnings = round(mean(Payoff.Fee, na.rm = T), 2))
```
```{r payoff_cal_understanding}
# Maybe it is the Payoff Variable
df_cal %>% 
  summarise(Mean_Earnings = round(mean(Payoff, na.rm = T), 2))
# Apparently Not

# Maybe it is just the sum of payoffs without any fees
df_cal %>% 
  filter(!is.na(Payoff)) %>% 
  pivot_longer(cols= starts_with("payoff_"), names_to = "round", 
               values_to = "payoff_rounds" ) %>% 
  # Rename Rounds
  mutate(round = as.numeric(str_replace(round, "payoff_", ""))) %>% 
  group_by(participant) %>% 
  summarise(sum_payoff = sum(payoff_rounds, na.rm = T)) %>% 
  summarise(mean_payoff = mean(sum_payoff))
# Closer but still not exactly 34.70 USD
```

# Deniability
```{r data_prep, message=FALSE, warning=FALSE}
df_cal %>% 
  pivot_longer(cols = starts_with("perception_"), names_to = "round", 
               values_to = "perception_round" ) %>% 
  mutate(round = as.numeric(str_replace(round, "perception_", ""))
         ) -> df_cal_long

df_cal %>% 
  pivot_longer(cols = starts_with("solved_"), names_to = "round",
               values_to = "solved_round" ) %>% 
  mutate(round = as.numeric(str_replace(round, "solved_", ""))) %>% 
  inner_join(df_cal_long) -> df_cal_long

df_cal_long %>% 
  group_by(round) %>% 
  summarise(mean_solved = mean(solved_round)*100, 
            mean_perception = mean(perception_round, na.rm = T)
            ) -> df_cal_mean_per_round
```

## Correlation
  - 0.79 (page 10)
```{r}
corr_solved_perception <- cor.test(x=df_cal_mean_per_round$mean_solved, 
                                   y=df_cal_mean_per_round$mean_perception)
print(round(corr_solved_perception$estimate, 2))
```
## Mean:
  - perceived: 47%
  - true: 32%
  
```{r deniability_stat}
df_cal_mean_per_round %>%   
  summarise(Mean_perception = round(mean(mean_perception, na.rm = T), 0),
            Mean_true = round(mean(mean_solved, na.rm = T), 0))
```
  - Round 7:
    - Perceived: 34%
    - True: 0%

```{r deniabilty_r_7}
df_cal_mean_per_round %>%  
  filter(round == 7) %>% 
  round(0)
```

## Figure 2
```{r fig_2}
df_cal_mean_per_round %>% 
  mutate(perception = mean_perception, solved = mean_solved) %>% 
ggplot() +
  geom_segment(aes(x=round, 
                  xend=round, 
                  y=solved, 
                  yend=perception),
                color="gray") +
  geom_point(aes(x=round,
                 y=solved,
                 color="Solved",
                 shape="Solved"), 
              size=3) +
  geom_point(aes(x=round, 
                 y=perception, 
                 color="Perception", 
                 shape="Perception"),
              size=3) +
  scale_color_viridis_d(name="",
                        direction = -1) +
  scale_shape(name="") +
  scale_x_continuous(breaks = seq(1, 10, 1)) +
  scale_y_continuous(limits=c(0,100),
                     breaks=seq(0,100,10)) +
  labs(x="Round", 
       y="Mean in %", 
       title="Percentage of True vs. Perceived Difficulty")
```

## Figure 4

```{r fig_4}
df %>% 
  mutate(participant = row_number()) %>% 
  pivot_longer(cols = starts_with("decision_"), names_to = "round", 
               values_to = "decision_round" ) %>% 
  mutate(round = as.numeric(str_replace(round, "decision_", ""))) %>%   
  filter(decision_round != "-") -> df_decision_long_stripped


ggplot() +
  geom_density(aes(x=frac_submit, fill="Submit"),
               alpha = 0.5,
               kernel = "gaussian",
               bw  = 0.1,
               data = df_decision_long_stripped %>% 
                 mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
                 group_by(participant) %>% 
                 summarise(frac_submit = mean(submit)) ) +
  geom_density(aes(x=frac_solved, fill="Solved"), 
               alpha = 0.5,
               kernel = "gaussian",
               bw  = 0.1,
               data = df_cal_long %>% 
                 group_by(participant) %>% 
                 summarise(frac_solved = mean(solved_round))) +
  scale_fill_viridis_d(name ="", 
                       direction = -1,
                       breaks = c("Solved", "Submit"),
                       labels = c("Participants solving independently (auxilairy sessions)",
                                  "Users choosing (C) Submit (main session)")) +
  labs(x="Fraction", 
       y="Density", 
       title="Distribution of (Claimed) Solutions") +
  theme(legend.position = "bottom",
        legend.direction = "vertical")
```

# Stealing: rival vs. non rival
## Statistics
  - Round 7
    - Rival: 51%, SD  = 0.51
    - Non-rival: 59%, SD  = 0.50
```{r steal_r_v_nr}
df_decision_long_stripped %>% 
  filter(round == 7) %>% 
  mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
  group_by(Treat) %>% 
  summarise(Percent_steal = round(mean(submit)*100,0),
            SD_steal = round(sd(submit),2))
```
## Statistical Tests
```{r steal_r_v_nr_stat_test}
df_decision_long_stripped %>% 
  filter(round == 7) %>% 
  mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
  t_test(submit~Treat, 
         comparisons = list(c("Nonrival", "Rival Main")))

df_decision_long_stripped %>% 
  filter(round == 7) %>% 
  mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
  wilcox_test(submit~Treat,  
              comparisons = list(c("Nonrival", "Rival Main")))

df_decision_long_stripped %>% 
  filter(round == 7) %>% 
  mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
  wilcox_test(submit~Treat, alternative = "greater", 
              comparisons = list(c("Nonrival", "Rival Main")))
```

# :TODO: 4 Which adjustment methods where used? not all here produce 1 as reported in the paper (page 18)
```{r wilcoxon_all_rounds}
for (adj_method in c("holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr")){
  print(paste("Method: ", adj_method))
  print(
    df_decision_long_stripped %>%
      mutate(submit = ifelse(decision_round == "S", 1, 0)) %>% 
      group_by(round) %>%
      wilcox_test(data =., submit~Treat,
                  comparisons = list(c("Nonrival", "Rival Main"))
                  ) %>%
      adjust_pvalue(method = adj_method) %>%
      add_significance("p.adj") %>% 
      select(round, p.adj)
  )
}
```

# :TODO: 5 Bayesian Factor Analysis

# :TODO: 6 Power of the study

## Figure 5 (Behavior rival vs. non-rival)

# :TODO: 7 In case you want to uses these figures I have to add the number of observations 
```{r fig.dim=c(8,10), message=FALSE, warning=FALSE}
df_decision_long_stripped %>% 
  pivot_wider(names_from = decision_round, 
              values_from = decision_round, 
              values_fill = 0,
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("S", "B", "N"),
               names_to = "Decision",
               values_to = "Decision_dummy") %>% 
  mutate(Decision = factor(Decision, levels = c("N", "B", "S"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit")),
         round = factor(round, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                        labels = c("Round 1", "Round 2", "Round 3", "Round 4", 
                                   "Round 5", "Round 6", "Round 7", "Round 8", 
                                   "Round 9", "Round 10"))) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  filter(Treat != "Supplementary Treatment") %>% 
ggplot(aes(x=Treat, y=Decision_dummy, fill=Decision)) +
  facet_wrap(~round, ncol = 2,
             strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  ylim(0, 1) +
  scale_fill_viridis_d(name = "") +
  theme(legend.position = "top") +
  labs(x = "",
       y= "Fraction of Users")
```

### Version 2
```{r}
df_decision_long_stripped %>% 
  pivot_wider(names_from = decision_round, 
              values_from = decision_round, 
              values_fill = 0,
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("S", "B", "N"),
               names_to = "Decision",
               values_to = "Decision_dummy") %>% 
  mutate(Decision = factor(Decision, levels = c("N", "B", "S"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit")),
         round = factor(round, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                        labels = c("Round 1", "Round 2", "Round 3", "Round 4", 
                                   "Round 5", "Round 6", "Round 7", "Round 8", 
                                   "Round 9", "Round 10"))) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  filter(Treat != "Supplementary Treatment") %>% 
  filter(Decision != "(A) Do Nothing") %>% 
ggplot(aes(x=round, y=Decision_dummy, fill=Treat)) +
  facet_wrap(~Decision, ncol = 1,
             strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  stat_summary(fun = "mean", aes(color = "True", y=mean_solved/100, x = round), 
               inherit.aes = F, geom = "crossbar",
               data =  df_cal_mean_per_round %>% 
                 mutate(Decision = "S") %>%
                 mutate(Decision = factor(Decision, levels= c("S", "B", "N"),
                           labels = c("(C) Sumbit", 
                                      "(B) Buy",
                                      "(A) Do Nothing")))) +
  ylim(0, 1) +
  scale_fill_viridis_d(name = "") +
  scale_color_viridis_d(name="", 
                        breaks = c("True"),
                        labels = c("True Deniability"), 
                        begin = 0.5) +
  theme(legend.position = "top") +
  labs(x = "",
       y= "Fraction of Users")
```

## Figure B.1 (Behavior supplementary vs. non-rival)
```{r fig.dim=c(8,10), message=FALSE, warning=FALSE}
df_decision_long_stripped %>% 
  pivot_wider(names_from = decision_round, 
              values_from = decision_round, 
              values_fill = 0,
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("S", "B", "N"),
               names_to = "Decision",
               values_to = "Decision_dummy") %>% 
  mutate(Decision = factor(Decision, levels = c("N", "B", "S"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit")),
         round = factor(round, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                        labels = c("Round 1", "Round 2", "Round 3", "Round 4", 
                                   "Round 5", "Round 6", "Round 7", "Round 8", 
                                   "Round 9", "Round 10"))) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  filter(Treat != "Rival Treatment") %>% 
ggplot(aes(x=Treat, y=Decision_dummy, fill=Decision)) +
  facet_wrap(~round, ncol = 2,
             strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  ylim(0, 1) +
  scale_fill_viridis_d(name = "") +
  theme(legend.position = "top") +
  labs(x = "",
       y= "Fraction of Users")
```

### Version 2
```{r}
df_decision_long_stripped %>% 
  pivot_wider(names_from = decision_round, 
              values_from = decision_round, 
              values_fill = 0,
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("S", "B", "N"),
               names_to = "Decision",
               values_to = "Decision_dummy") %>% 
  mutate(Decision = factor(Decision, levels = c("N", "B", "S"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit")),
         round = factor(round, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                        labels = c("Round 1", "Round 2", "Round 3", "Round 4", 
                                   "Round 5", "Round 6", "Round 7", "Round 8", 
                                   "Round 9", "Round 10"))) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  filter(Treat != "Rival Treatment") %>% 
  filter(Decision != "(A) Do Nothing") %>% 
ggplot(aes(x=round, y=Decision_dummy, fill=Treat)) +
  facet_wrap(~Decision, ncol = 1,
             strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  stat_summary(fun.data = mean_se, aes(color = "True", y=mean_solved/100, x = round), 
               inherit.aes = F, geom = "crossbar",
               data =  df_cal_mean_per_round %>% 
                 mutate(Decision = "S") %>%
                 mutate(Decision = factor(Decision, levels= c("S", "B", "N"),
                           labels = c("(C) Sumbit", 
                                      "(B) Buy",
                                      "(A) Do Nothing")))) +
  ylim(0, 1) +
  scale_fill_viridis_d(name = "") +
  scale_color_viridis_d(name="", 
                        breaks = c("True"),
                        labels = c("True Deniability"), 
                        begin = 0.5) +
  theme(legend.position = "top") +
  labs(x = "",
       y= "Fraction of Users")
```


# Social Norms

## Statistics
  - Submit:
    - Rival: 1.60 (SD = 0.75)
    - Non-rival: 1.50 (SD = 0.65)
  - Buy:
    - Rival: 3.60 (SD = 0.65)
    - Non-rival: 3.77 (SD = 0.43)
  - Do Nothing:
    - Rival: 2.78 (SD = 0.82)
    - Non-rival: 2.48 (SD = 0.83)

```{r}
df %>% 
  group_by(Treat) %>% 
  summarise(Mean_submit = mean(KW_C),
            Sd_submit = sd(KW_C),
            Mean_buy = mean(KW_B),
            Sd_buy = sd(KW_B),
            Mean_nothing = mean(KW_A),
            Sd_nothing = sd(KW_A))
```

```{r}
wilcox_test(KW_C~Treat, data = df,  
            comparisons = list(c("Nonrival", "Rival Main")))
```

```{r}
t_test(KW_C~Treat, data = df,  
            comparisons = list(c("Nonrival", "Rival Main")))
```

## Figure 6
```{r}
social_norms <- function(x){
  if (x == 1){
    return("VI")
  } else if (x == 2){
    return("SI")
  } else if (x == 3){
    return("SA")
  } else if (x == 4){
    return("VA")
  }
}

df %>% 
  rename(C = KW_C, B = KW_B, A = KW_A) %>%
  mutate(A = sapply(A, social_norms),
         B = sapply(B, social_norms),
         C = sapply(C, social_norms)) %>% 
  pivot_longer(cols = c("A", "B", "C"), 
               names_to = "Decision", 
               values_to = "Social_acc") %>%
  pivot_wider(names_from = "Social_acc", 
              values_from = "Social_acc", 
              values_fill = 0, 
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("VA", "SA", "SI", "VI"), 
               names_to = "Appropriatness",
               values_to = "Appropriatness_dummy") %>%
  mutate(Decision = factor(Decision, levels = c("A", "B", "C"),
                           labels = c("(B) Buy",
                                      "(A) Do Nothing",
                                      "(C) Sumbit") )) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  mutate(Appropriatness = factor(Appropriatness, levels = c("VI", "SI", "SA", "VA"),
                                 labels = c("Very 
Socially 
Inappropriate",
"Somewhat 
Socially 
Inappropriate",
"Somewhat 
Socially 
Appropriate",
"Very 
Socially 
Appropriate"))) %>% 
  filter(Treat != "Supplementary Treatment", Decision == "(C) Sumbit") %>% 
ggplot(aes(x=Appropriatness, y=Appropriatness_dummy, fill= Treat)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  scale_fill_viridis_d(name = "") +
  ylim(0, 1) +
  labs(x="", y = "Fraction of Users") +
  theme(legend.position = "top")
```

### All Decision Rival Main
```{r, fig.dim=c(8,10)}
social_norms <- function(x){
  if (x == 1){
    return("VI")
  } else if (x == 2){
    return("SI")
  } else if (x == 3){
    return("SA")
  } else if (x == 4){
    return("VA")
  }
}

df %>% 
  rename(C = KW_C, B = KW_B, A = KW_A) %>%
  mutate(A = sapply(A, social_norms),
         B = sapply(B, social_norms),
         C = sapply(C, social_norms)) %>% 
  pivot_longer(cols = c("A", "B", "C"), 
               names_to = "Decision", 
               values_to = "Social_acc") %>%
  pivot_wider(names_from = "Social_acc", 
              values_from = "Social_acc", 
              values_fill = 0, 
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("VA", "SA", "SI", "VI"), 
               names_to = "Appropriatness",
               values_to = "Appropriatness_dummy") %>%
  mutate(Decision = factor(Decision, levels = c("A", "B", "C"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit") )) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  mutate(Appropriatness = factor(Appropriatness, levels = c("VI", "SI", "SA", "VA"),
                                 labels = c("Very 
Socially 
Inappropriate",
"Somewhat 
Socially 
Inappropriate",
"Somewhat 
Socially 
Appropriate",
"Very 
Socially 
Appropriate"))) %>% 
  filter(Treat != "Supplementary Treatment") %>% 
ggplot(aes(x=Appropriatness, y=Appropriatness_dummy, fill= Treat)) +
  facet_wrap(~Decision, ncol = 1, strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  scale_fill_viridis_d(name = "") +
  ylim(0, 1) +
  labs(x="", y = "Fraction of Users") +
  theme(legend.position = "top")
```

### All Decisions Rival Supplementary
```{r, fig.dim=c(8,10)}
df %>% 
  rename(C = KW_C, B = KW_B, A = KW_A) %>%
  mutate(A = sapply(A, social_norms),
         B = sapply(B, social_norms),
         C = sapply(C, social_norms)) %>% 
  pivot_longer(cols = c("A", "B", "C"), 
               names_to = "Decision", 
               values_to = "Social_acc") %>%
  pivot_wider(names_from = "Social_acc", 
              values_from = "Social_acc", 
              values_fill = 0, 
              values_fn = function(x){return(1)}) %>% 
  pivot_longer(cols = c("VA", "SA", "SI", "VI"), 
               names_to = "Appropriatness",
               values_to = "Appropriatness_dummy") %>%
  mutate(Decision = factor(Decision, levels = c("A", "B", "C"),
                           labels = c("(A) Do Nothing",
                                      "(B) Buy",
                                      "(C) Sumbit") )) %>% 
  mutate(Treat = factor(Treat, levels = c("Nonrival", "Rival Main", "Rival Supp."),
                        labels = c("Nonrival Treatment", "Rival Treatment", 
                            "Supplementary Treatment"))) %>% 
  mutate(Appropriatness = factor(Appropriatness, levels = c("VI", "SI", "SA", "VA"),
                                 labels = c("Very 
Socially 
Inappropriate",
"Somewhat 
Socially 
Inappropriate",
"Somewhat 
Socially 
Appropriate",
"Very 
Socially 
Appropriate"))) %>% 
  filter(Treat != "Rival Treatment") %>% 
ggplot(aes(x=Appropriatness, y=Appropriatness_dummy, fill= Treat)) +
  facet_wrap(~Decision, ncol = 1, strip.position = "bottom") +
  stat_summary(fun = "mean", geom = "bar", position = "dodge2") +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge2(width = 0.5, padding = 0.5)) +
  scale_fill_viridis_d(name = "") +
  ylim(0, 1) +
  labs(x="", y = "Fraction of Users") +
  theme(legend.position = "top")
```

# Dictator Game

User keep: 1.39 

# :TODO: 8 I get different values (page 22)

```{r}
df %>% 
  summarise(Mean_keep = mean(dictator_kept), 
            Percent_keep = mean(dictator_kept)/2 ) %>% 
  round(2)

df %>% 
  filter(Treat != "Rival Supp.") %>% 
  summarise(Mean_keep = mean(dictator_kept), 
            Percent_keep = mean(dictator_kept)/2 ) %>% 
  round(2)
```
Percent of users who share: 77%

# :TODO: 9 I get a different value (page 22)

```{r}
df %>% 
  mutate(Dictator_give_smtn = ifelse(dictator_kept != 2, 1, 0)) %>% 
  summarise(Percent_give_smtn = mean(Dictator_give_smtn))
```

```{r}
df %>% 
  filter(Treat != "Rival Supp.") %>% 
  mutate(Dictator_give_smtn = ifelse(dictator_kept != 2, 1, 0)) %>% 
  summarise(Percent_give_smtn = mean(Dictator_give_smtn))
```

# Linear Regression

## Data Prep
```{r}
df %>% 
  mutate(participant = row_number()) %>% 
  pivot_longer(cols = starts_with("short_"), names_to = "round", 
               values_to = "short_round" ) %>% 
  mutate(round = as.numeric(str_replace(round, "short_", ""))) %>% 
  group_by(participant) %>% 
  summarise(scrabble_ability = sum(short_round)) %>% 
  right_join(df_decision_long_stripped)  %>% 
  mutate(submit = ifelse(decision_round == "S", 1, 0), 
         Treatment = ifelse(Treatment=="rival", 1, 0), 
         non_swiss = ifelse(national == "Switzerland", 0, 1),
         non_eth = ifelse(University == "ETHZ", 0, 1),
         no_field = ifelse(Study_field == "no_field", 1, 0),
         non_student = ifelse(University == "nicht", 1, 0),
         stem = ifelse(STEM == 1, 1, 0),
         law_stud = ifelse(Law == 1, 1, 0),
         dictator_sharing = 2-dictator_kept) -> df_lm
```

Styling
```{r}
coef_map = c("rival_main"="Rival Treatment",
             "rival_supp" = "Supplementary Treatment", 
             "sex_d" = "Male", 
             "age" = "Age",
             "non_swiss" = "Non-Swiss",
             "monthly_budget" = "Monthly_Budget",
             "non_eth" = "Non-ETH Student",
             "law_stud" = "Law Student",
             "scrabble_ability" = "Scrabble Ability", 
             "dictator_sharing" = "Dictator Sharing", 
             "KW_C" = "Social Appropriateness")

gm_map <- list(
  list("raw" = "nobs", "clean" = "Observations", "fmt" = 0),
  list("raw" = "r.squared", "clean" = "R²", "fmt" = 3),
  list("raw" = "adj.r.squared", "clean" = "Adjusted R²", "fmt" = 3))
```

```{r}
models_lr <- list()

models_lr[["(1)"]] <- lm_robust(
  submit ~ rival_main + rival_supp,
  clusters = participant,
  data = df_lm,
  se_type = "stata")

models_lr[["(2)"]] <- lm_robust(
  submit ~ rival_main + rival_supp + sex_d + age +  non_swiss ,
  clusters = participant,
  data = df_lm,
  se_type = "stata")

models_lr[["(3)"]] <- lm_robust(
  submit ~ rival_main + rival_supp + sex_d + age +  non_swiss + monthly_budget + 
    non_eth + law_stud + scrabble_ability + dictator_sharing + KW_C + no_field +
    non_student + stem,
  clusters = participant,
  data = df_lm,
  se_type = "stata")

rows <- tribble(~term,             ~first,  ~sec, ~th,
                'Residual Std. Error',   paste(
    as.character(round(sqrt(models_lr[["(1)"]]$res_var),3)), "(df = ",
    as.character(round(models_lr[["(1)"]]$df.residual,3)) ,")" ) ,   
                paste(
    as.character(round(sqrt(models_lr[["(2)"]]$res_var),3)), "(df = ",
    as.character(round(models_lr[["(2)"]]$df.residual,3)) ,")" ), 
                paste(
    as.character(round(sqrt(models_lr[["(3)"]]$res_var),3)), "(df = ",
    as.character(round(models_lr[["(3)"]]$df.residual,3)) ,")" ))
```

# :TODO: 10 I get a different coefficient for Law the rest is equal (page 34)
```{r}
modelsummary(
  models_lr, 
  fmt = 3,
  stars = T, 
  coef_map = coef_map,
  estimate = "{estimate} ({std.error}){stars}",
  statistic = NULL, 
  gof_map = gm_map,
  add_rows = rows,
  conf_level = .95) %>% add_header_above(c(" " = 1, "Submit" = 3),) %>% 
  add_header_above(c(" " = 1, "Dependent variable:" = 3), bold = T, italic = T) 
```


# Page 13
## Footnote 11:
```{r}
df_decision_long_stripped %>% 
  group_by(decision_round) %>% 
  summarise(count = n(), 
            percent = round(n()/nrow(df_decision_long_stripped)*100,1) )
```
